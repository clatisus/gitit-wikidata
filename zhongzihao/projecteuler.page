## 488. Unbalanced Nim

**题目大意**：给你三堆石子，每堆石子的数量互不相同，两人轮流取走石子，每次可以选择一堆，从中取走一个以上的石子，要求取完之后仍要满足每堆石子的数量互不相同，最后不能操作者输。设三堆石子的数量分别为 $a,b,c$，设 $F(n)$ 表示满足 $0<a<b<c<n$ 的所有负态的 $(a+b+c)$ 之和，求 $F(10^{18})\mod10^{9}$。

**题解**：先来研究负态满足的条件：

手动打表可以发现，负态为所有满足 $i\ge 0, 0\le j<2^{i},k\ge1,0\le u<2^{i}$ 的 $(2^{i}+j-1,2^{i+1}k+u-1,2^{i+1}k+2^{i}+(j\oplus u)-1)$。为了方便证明，不妨将三个数都加上 $1$，并稍微改写一下式子，得到：负态为所有满足 $i\ge 0, 0\le j<2^{i},k\ge1,0\le u<2^{i}$ 的 $(2^{i}+(j\oplus u),2^{i+1}k+j,2^{i+1}k+2^{i}+u)$。这等价于下面的叙述：设 $a,b,c(a<b<c)$ 的无前导 $0$ 二进制表示分别为 $a=a'_{n_{a}}\cdots a'_{0},b=b'_{n_{b}}\cdots b'_{0},c=c'_{n_{c}}\cdots c'_{0}$，$b$ 和 $c$ 最高的不相同的位为第 $i$ 位，则 $(a,b,c)$ 为负态的充要条件为：$n_{b}=n_{c}$，且 $a=b\oplus c$。下面我们用归纳法来证明这一结论：

显然 $(1,2,3)$ 为负态，且满足上面的要求。

先证明不满足上面形式的状态是胜态：

- 若 $n_{b}<n_{c}$

    - 若 $n_{a}=n_{b}$，则 $(a\oplus b,a,b)$ 是一个负态。
    - 若 $n_{a}<n_{b}$
        - 若 $b'_{n_{a}}=1$，则 $(a,a\oplus b,b)$ 是一个负态。
        - 若 $b'_{n_{a}}=0$，则 $(a,b,a\oplus b)$ 是一个负态。

- 若 $n_{b}=n_{c}$

    - 若 $a>b\oplus c$，那么 $(b\oplus c,b,c)$ 是一个负态。

    - 若 $a<b\oplus c$

        - 若 $n_{a}<i$

            - 若 $b'_{n_{a}}=1$，则 $(a,a\oplus b,b)$ 是一个负态。
            - 若 $b'_{n_{a}}=0$，则 $(a,b,a\oplus b)$ 是一个负态。

        - 若 $n_{a}=i$，我们来证明 $a\oplus c<b$ 和 $a\oplus b<c$ 至少有一个成立：

      设 $a$ 和 $b\oplus c$ 最高的不相同的位为第 $j$ 位，则有 $(a'_{n_{c}}\oplus c'_{n_{c}})\cdots(a'_{j+1}\oplus c'_{j+1})=b'_{n_{c}}\cdots b'_{j+1}$ 和 $(a'_{n_{b}}\oplus b'_{n_{b}})\cdots(a'_{j+1}\oplus b'_{j+1})=c'_{n_{b}}\cdots c'_{j+1}$ 均成立。又因为 $a<b\oplus c$，所以有 $a'_{j}=0,b'_{j}\oplus c’_{j}=1$，故 $a'_{j}\oplus c'_{j}<b'_{j}$ 和 $a'_{j}\oplus b '_{j}<c'_{j}$ 至少有一个成立，即 $a\oplus c<b$ 和 $a\oplus b<c$ 至少有一个成立。$\Box$

           - 若 $a\oplus c<b$，则 $(a,a\oplus c,c)$ 是一个负态。
           - 若 $a\oplus b<c$，则 $(a,b,a\oplus b)$ 是一个负态。

再证明满足上面形式的状态是负态：

- 若从 $a$ 中取石子，由于 $a$ 是由 $b,c$ 唯一确定的，故取走 $a$ 中石子后肯定是胜态。
- 若从 $b$ 中取石子
    - 若取完后 $b$ 的位数小于 $c$ 的位数，显然最大的两个数的位数不可能相等，也是一个胜态。
    - 若取完后 $b$ 的位数等于 $c$ 的位数，根据异或运算的性质，$b$ 和 $c$ 的异或值肯定发生了变化，$a$ 也肯定不满足负态的要求。
- 若从 $c$ 中取石子，与 $b$ 类似可证。$\Box$

最后的答案可以通过一个简单的数位 $dp$ 得到，这里就不再赘述了。